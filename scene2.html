<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
<head>
<style>
/* Style taken from:  https://typespiration.com/clean-slate */
h1 { color: #333333; font-family: 'Georgia', serif; font-size: 50px; font-weight: normal; line-height: 54px; margin: 0 0 24px; }
p { color: #333333; font-family: Georgia, serif; font-size: 18px; line-height: 28px; margin: 0 100 28px; }
p:first-of-type { font-size: 26px; line-height: 36px; margin: 0 0 58px; text-align: center;}
a {
  text-decoration: none;
  display: inline-block;
  padding: 8px 16px;
  font-family: 'Georgia', serif;
  font-size: 26px;
}

a:hover {
  background-color: #ddd;
  color: black;
}

.previous {
  background-color: #f1f1f1;
  color: black;
}

.next {
  background-color: #046DAA;
  color: white;
}

h1 {text-align: center;}
circle {stroke: black;}
.center {
    display: flex;
    justify-content: space-around;
  /*margin-left: auto;
  margin-right: auto;*/
}
</style>
</head>
<body onload='init()'>
<h1>Are Americans getting educated?</h1>
<p>By Rodrigo Mendoza</p>
<p> For <strong>Education</strong> majors, however, this number has been decreasing <strong>drastically!</strong></p>
<p> And for <strong>Social sciences and history (SS&H)</strong>, the number has been steady over the years. This means the percentage of graduates is now much lower than before!</p>
<table class="center">
  <tr>
    <th>
        <p>Education degrees</p>
        <svg id="education"></svg>
    </th>
    <th>
        <p>Fraction relative to all degrees</p>
        <svg id="education_fraction"></svg>
    </th>
  </tr>
  <tr>
    <th>
        <p>SS&H degrees</p>
        <svg id="social_graph"></svg>
    </th>
    <th>
        <p>Fraction relative to all degrees</p>
        <svg id="social_graph_fraction"></svg>
    </th>
  </tr>
</table>
<div class="center">
    <a href="scene1.html" class="previous">&laquo; Back</a>
    <a href="scene3.html" class="next">Continue &raquo;</a>
</div>
<br><br><br><br>
</body>
<script>

function getSvgWithMargins(id, width, height, margin) {
    return d3.select(id)
            .attr("width", width + 2*margin)
            .attr("height", height + 2*margin)
        .append("g")
            .attr("transform", "translate(" + margin + "," + margin + ")");
}

function formatXAxis(svg, height, x, ticks) {
    svg.append("g")
        .attr("transform", "translate(0," + (height*0.82) + ")")
        .call(d3.axisBottom(x)
            .tickSize(-height*0.82)
            .tickValues(ticks)
            .tickFormat(d3.format(".4")))
        .select(".domain").remove();
    svg.selectAll(".tick line").attr("stroke", "#bbbbbb");
}

function formatYAxis(svg, width, y, max) {
    let values = []
    for (let i = 0; i <= max; i += max/10) {
        values.push(i);
    }
    let a = svg.append("g")
        .call(d3.axisLeft(y)
            .tickSize(-width)
            .tickValues(values)
            .tickFormat((d) => "" + (d)/1000 + "k"))
        .select(".domain").remove();
    svg.selectAll(".tick line").attr("stroke", "#bbbbbb");
}

function formatYAxisPercent(svg, width, y, max) {
    let percents = []
    for (let i = 0; i <= max; i += 0.05) {
        percents.push(i);
    }
    let a = svg.append("g")
        .call(d3.axisLeft(y)
            .tickSize(-width)
            .tickValues(percents)
            .tickFormat((d) => "" + Math.round(100*(d)) + "%"))
        .select(".domain").remove();
    svg.selectAll(".tick line").attr("stroke", "#bbbbbb");
}

function getSums(data) {
    let sums = [];
    for (let i = 0; i < data.length; i++) {
        let sum = 0;
        for (let key in data[i]) {
            if (key != 'Year') {
                sum += parseInt(data[i][key]);
            } else {
                year = data[i][key];
            }
        }

        sums.push({'Year': year, 'Value': sum});
    }
    return sums;
}
function getData(data, field) {
    let vals = [];
    for (let i = 0; i < data.length; i++) {
        let val = 0;
        for (let key in data[i]) {
            if (key == field) {
                val = parseInt(data[i][key])
            } else if (key == 'Year') {
                year = data[i][key];
            }
        }

        vals.push({'Year': year, 'Value': val});
    }
    return vals;
}
function getRelative(data, sums) {
    let relative = [];
    for (let i = 0; i < data.length; i++) {
        relative.push({'Year': data[i].Year, 'Value': (data[i].Value/sums[i].Value)});
    }
    return relative;
}

function generateArea(x, y, height) {
    return d3.area()
    .x(function(d) { return x(d.Year); })
    .y0(function(d) { return y(height); })
    .y1(function(d) { return y(d.Value); });
}

function getBounds(element) {
    return element.node().getBoundingClientRect();
}

async function init() {
    let margin = 30,
        width = 500 - 2*margin;
        height = 400 - 2*margin;

    let svgEdu = getSvgWithMargins("#education", width, height, margin);
    let svgEduRelative = getSvgWithMargins("#education_fraction", width, height, margin);
    let svgSsh = getSvgWithMargins("#social_graph", width, height, margin);
    let svgSshRelative = getSvgWithMargins("#social_graph_fraction", width, height, margin);

    data = await d3.csv("https://rm36.github.io/degrees_conferred.csv");
    let sums = getSums(data),
        education = getData(data, "Education"),
        educationRelative = getRelative(education, sums),
        ssh = getData(data, "Social sciences and history"),
        sshRelative = getRelative(ssh, sums);

    let yearsExtent = d3.extent(data, function(d) { return d.Year; }),
        valuesExtent = [0, 180000],
        relativeExtent = [0, 0.25];
    let xScale = d3.scaleLinear().domain(yearsExtent).range([ 0, width ]);

    let years = [1971, 1980, 1990, 2000, 2010, 2020];
    formatXAxis(svgEdu, height, xScale, years);
    formatXAxis(svgEduRelative, height, xScale, years);
    formatXAxis(svgSsh, height, xScale, years);
    formatXAxis(svgSshRelative, height, xScale, years);

    let yScale = d3.scaleLinear().domain(valuesExtent).range([height * 0.8, 0]);
    let yRelativeScale = d3.scaleLinear().domain(relativeExtent).range([height * 0.8, 0]);
    formatYAxis(svgEdu, width, yScale, valuesExtent[1]);
    formatYAxisPercent(svgEduRelative, width, yRelativeScale, relativeExtent[1]);
    formatYAxis(svgSsh, width, yScale, valuesExtent[1]);
    formatYAxisPercent(svgSshRelative, width, yRelativeScale, relativeExtent[1]);

    let line = d3.line().x(function(d) { return xScale(d.Year); })
                        .y(function(d) { return yScale(d.Value); });
    let lineRelative = d3.line().x(function(d) { return xScale(d.Year); })
                                .y(function(d) { return yRelativeScale(d.Value); });
    console.log(line);

    let valuesArea = d3.area()
        .x(function(d) { return xScale(d.Year); })
        .y0(height * 0.8)
        .y1(function(d) { return yScale(d.Value); });
    let relativeArea = d3.area()
        .x(function(d) { return xScale(d.Year); })
        .y0(height * 0.8)
        .y1(function(d) { return yRelativeScale(d.Value); });

    svgEdu.append("path")
            .datum(education)
            .attr("d", valuesArea)
            .attr("stroke", "black")
            .attr("stroke-width", 1.5)
            .attr("fill", "#17becf")

    svgEduRelative.append("path")
            .datum(educationRelative)
            .attr("d", relativeArea)
            .attr("stroke", "black")
            .attr("stroke-width", 1.5)
            .attr("fill", "#17becf")

    svgSsh.append("path")
            .datum(ssh)
            .attr("d", valuesArea)
            .attr("stroke", "black")
            .attr("stroke-width", 1.5)
            .attr("fill", "#2ca02c")

    svgSshRelative.append("path")
            .datum(sshRelative)
            .attr("d", relativeArea)
            .attr("stroke", "black")
            .attr("stroke-width", 1.5)
            .attr("fill", "#2ca02c")

    // Year labels
    svgEdu.append("text")
        .attr("text-anchor", "end")
        .attr("x", width/2)
        .attr("y", height-30 )
        .text("Year");
    svgEduRelative.append("text")
        .attr("text-anchor", "end")
        .attr("x", width/2)
        .attr("y", height-30 )
        .text("Year");
    svgSsh.append("text")
        .attr("text-anchor", "end")
        .attr("x", width/2)
        .attr("y", height-30 )
        .text("Year");
    svgSshRelative.append("text")
        .attr("text-anchor", "end")
        .attr("x", width/2)
        .attr("y", height-30 )
        .text("Year");

    const annotations = [
      {
        note: {
          label: "",
          title: "",
          bgPadding: 0,
          align: "left",
          wrapSplitter: /\n/,
        },
        x: 0,
        y: 0,
        dy: 50,
        dx: 50,
        color: "#000000",
        connector: { end: "dot" },
        type: d3.annotationCalloutElbow,
      }
    ];
}

</script>
</body>
</html>