<html>
<script src='https://d3js.org/d3.v5.min.js'></script>
<script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
<head>
<style>
/* Style taken from:  https://typespiration.com/clean-slate */
h1 { color: #333333; font-family: 'Georgia', serif; font-size: 50px; font-weight: normal; line-height: 54px; margin: 0 0 24px; }
p { color: #333333; font-family: Georgia, serif; font-size: 18px; line-height: 28px; margin: 0 100 28px; }
p:first-of-type { font-size: 26px; line-height: 36px; margin: 0 0 58px; text-align: center;}
a {
  text-decoration: none;
  display: inline-block;
  padding: 8px 16px;
  font-family: 'Georgia', serif;
  font-size: 26px;
}

a:hover {
  background-color: #ddd;
  color: black;
}

.previous {
  background-color: #f1f1f1;
  color: black;
}

.next {
  background-color: #046DAA;
  color: white;
}

h1 {text-align: center;}
circle {stroke: black;}
.center {
    display: flex;
    justify-content: space-around;
  /*margin-left: auto;
  margin-right: auto;*/
}
</style>
</head>
<body onload='init()'>
<h1>Are Americans getting educated?</h1>
<p>By Rodrigo Mendoza</p>
<p>
    Each year, the number of bachelor degrees conferred in the USA has been increasing. This is not really a surprise, but did you know the steepest increase was around <strong>2006</strong>?.</p>
<p>
    Another little-known fact is that in the last 30 years, this number has more than <strong>doubled</strong>. In 1971, the number of degrees conferred in the USA was <strong>839,730</strong>. In 2020, that number climbed to <strong>2'038,431</strong>.
    That's an increase to <strong>240%</strong>!</p>
<table class="center">
  <tr>
    <th>
        <p>Number of degrees conferred</p>
        <svg id="total_graph"></svg>
    </th>
  </tr>
</table>
<div class="center">
    <a href="scene2.html" class="next">Continue &raquo;</a>
</div>
<br><br><br><br>
</body>
<script>

function getSvgWithMargins(id, width, height, margin) {
    return d3.select(id)
            .attr("width", width + 2*margin)
            .attr("height", height + 2*margin)
        .append("g")
            .attr("transform", "translate(" + margin + "," + margin + ")");
}

function formatXAxis(svg, height, x, ticks) {
    svg.append("g")
        .attr("transform", "translate(0," + (height*0.82) + ")")
        .call(d3.axisBottom(x)
            .tickSize(-height*0.82)
            .tickValues(ticks)
            .tickFormat(d3.format(".4")))
        .select(".domain").remove();
    svg.selectAll(".tick line").attr("stroke", "#bbbbbb");
}

function formatYAxis(svg, width, y, max) {
    let values = []
    for (let i = 0; i <= max; i += max/10) {
        values.push(i);
    }
    let a = svg.append("g")
        .call(d3.axisLeft(y)
            .tickSize(-width)
            .tickValues(values)
            .tickFormat((d) => "" + (d)/1000 + "k"))
        .select(".domain").remove();
    svg.selectAll(".tick line").attr("stroke", "#bbbbbb");
}

function formatYAxisPercent(svg, width, y, min, max) {
    let values = []
    for (let i = min; i <= max; i += (min/5)) {
        values.push(i);
    }
    let a = svg.append("g")
        .attr("transform", "translate("+width+",0)")
        .call(d3.axisRight(y)
            .tickValues(values)
            .tickFormat((d) => "" + Math.round(100*d/min) + "%"))
        .select(".domain").remove();
    svg.selectAll(".tick line").attr("stroke", "#bbbbbb");
}

function getSums(data) {
    let sums = [];
    for (let i = 0; i < data.length; i++) {
        let sum = 0;
        for (let key in data[i]) {
            if (key != 'Year') {
                sum += parseInt(data[i][key]);
            } else {
                year = data[i][key];
            }
        }

        sums.push({'Year': year, 'Value': sum});
    }
    return sums;
}

function generateArea(x, y, height) {
    return d3.area()
    .x(function(d) { return x(d.Year); })
    .y0(function(d) { return y(height); })
    .y1(function(d) { return y(d.Value); });
}

function getBounds(element) {
    return element.node().getBoundingClientRect();
}

async function init() {
    let margin = 60,
        width = 600 - 2*margin;
        height = 500 - 2*margin;

    let svg = getSvgWithMargins("#total_graph", width, height, margin);

    data = await d3.csv("https://rm36.github.io/degrees_conferred.csv");
    let sums = getSums(data);

    let yearsExtent = d3.extent(data, function(d) { return d.Year; }),
        sumsExtent = [0, 2500000]
    let xScale = d3.scaleLinear().domain(yearsExtent).range([ 0, width ]);

    let years = [1971, 1980, 1990, 2000, 2010, 2020];
    formatXAxis(svg, height, xScale, years);

    let yScale = d3.scaleLinear().domain(sumsExtent).range([height * 0.8, 0]);
    formatYAxis(svg, width, yScale, sumsExtent[1]);
    formatYAxisPercent(svg, width, yScale, /*min=*/839730, sumsExtent[1]);

    let line = d3.line().x(function(d) { return xScale(d.Year); })
                        .y(function(d) { return yScale(d.Value); });

    let sumsArea = d3.area()
        .x(function(d) { return xScale(d.Year); })
        .y0(height * 0.8)
        .y1(function(d) { return yScale(d.Value); });

    let degreeAreas = svg
        .append("path")
            .datum(sums)
            .attr("d", sumsArea)
            .attr("stroke", "black")
            .attr("stroke-width", 1.5)
            .attr("fill", "#046DAA")

    svg.append("text")
        .attr("text-anchor", "end")
        .attr("x", width/2)
        .attr("y", height-20 )
        .text("Year");

    let leftAxisLabel = {"x": -40, "y": height/2 - 130}
    svg.append("text")
        .attr("text-anchor", "end")
        .attr("x", leftAxisLabel.x)
        .attr("y", leftAxisLabel.y )
        .attr("transform", "rotate(-90," + leftAxisLabel.x + "," + leftAxisLabel.y + ")")
        .text("Number of degrees (thousands)");

    let rightAxisLabel = {"x": width + 40, "y": height/2 + 60}
    svg.append("text")
        .attr("text-anchor", "end")
        .attr("x", rightAxisLabel.x)
        .attr("y", rightAxisLabel.y )
        .attr("transform", "rotate(90," + rightAxisLabel.x + "," + rightAxisLabel.y + ")")
        .text("Percentage relative to 1971");

    const annotations = [
      {
        note: {
          title: "2006",
          label: "+240k degrees / year",
          bgPadding: 0,
          align: "left",
          wrapSplitter: /\n/,
        },
        x: xScale(2006),
        y: yScale(1485104),
        dy: -10,
        dx: -250,
        color: "#bb0000",
        connector: { end: "dot" },
        type: d3.annotationCalloutElbow,
      },
      {
        note: {
          title: "1971",
          label: "840k degrees conferred",
          bgPadding: 0,
          align: "left",
          wrapSplitter: /\n/,
        },
        x: xScale(1971),
        y: yScale(840000),
        dy: 10,
        dx: 50,
        color: "#660000",
        connector: { end: "dot" },
        type: d3.annotationCalloutElbow,
      },
      {
        note: {
          title: "2020",
          label: "> 2M degrees conferred",
          bgPadding: 0,
          align: "left",
          wrapSplitter: /\n/,
        },
        x: xScale(2020),
        y: yScale(2038431),
        dy: -10,
        dx: -250,
        color: "#bb0000",
        connector: { end: "dot" },
        type: d3.annotationCalloutElbow,
      },
    ];

    makeAnnotations = d3.annotation().annotations(annotations);
    svg.append("g").call(makeAnnotations);
}

</script>
</body>
</html>